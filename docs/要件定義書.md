# 要件定義書: Gmailメール管理アプリ

**バージョン:** 1.2
**作成日:** 2025年5月7日
**最終更新日:** 2025年5月7日

## 1. はじめに

### 1.1. プロジェクトの目的
本プロジェクトの目的は、ユーザーのGmailアカウントからメールを読み込み、GoogleのGemini APIを利用して各メールの内容の重要度を判定し、重要と判定されたメールをユーザーに分かりやすく提示するAndroidアプリケーション（以下、本アプリ）を開発することである。バックエンド処理はAWS (Amazon Web Services) 上でKotlinを用いて構築し、フロントエンドからバックエンドまで一貫した開発言語による効率性と、クラウドネイティブなスケーラビリティおよび堅牢性を実現する。

### 1.2. プロジェクトの背景
日々大量のメールを受信するユーザーにとって、重要なメールを見逃さずに効率的に処理することは大きな課題である。本アプリは、AIによるメールの重要度判定機能を提供することで、ユーザーがメール管理にかける時間を削減し、生産性向上に貢献することを目指す。また、本プロジェクトは、プログラミング経験が浅いメンバーを含むチームが、AIエージェントやクラウドサービス（AWS）、モダンな開発言語（Kotlin）を活用した開発スタイルを経験し、スキルアップを図ることも目的の一つとする。

### 1.3. 対象読者
本ドキュメントは、以下の関係者を対象とする。
* プロジェクトマネージャー
* 開発チームメンバー（Androidエンジニア、AWSバックエンドエンジニア）
* UI/UXデザイナー（該当する場合）
* 品質保証担当者

### 1.4. 用語定義
| 用語        | 説明                                                                 |
| ----------- | -------------------------------------------------------------------- |
| 本アプリ    | 本要件定義書で定義されるGmailメール管理アプリケーション                     |
| Gmail API   | Googleが提供するGmailのメールデータにアクセスするためのAPI                   |
| Gemini API  | Googleが提供する大規模言語モデルを利用するためのAPI。本アプリではメールの重要度判定に使用 |
| AWS         | Amazon Web Services。本アプリのバックエンド基盤として利用                 |
| Lambda      | AWSのサーバーレスコンピューティングサービス                               |
| API Gateway | AWSのAPI作成・管理サービス                                                |
| DynamoDB    | AWSのNoSQLデータベースサービス                                           |
| Cognito     | AWSのユーザー認証・認可サービス                                         |
| MVVM        | Model-View-ViewModel。Androidアプリの設計パターンの一つ                |
| 重要度インジケータ | メールの重要度を視覚的に示すためのUI要素（例：アイコン、色、ラベル）       |
| プロンプト    | Gemini APIなどのAIモデルに対して、特定の出力を得るために与える指示や文脈情報 |

## 2. プロジェクト概要

### 2.1. システム概要
本アプリは、Androidデバイス上で動作するフロントエンドアプリケーションと、AWS上で動作するバックエンドサービスで構成される。ユーザーはAndroidアプリを通じてGmailアカウントに連携し、メール情報を閲覧する。バックエンドサービスは、Gmail APIを介してメールを取得し、Gemini APIを利用して重要度を判定、その結果をフロントエンドに提供する。

### 2.2. プロジェクトスコープ

#### 2.2.1. スコープ内 (In-Scope)
* ユーザー認証機能（Google Sign-In）
* Gmailアカウント連携機能（メール読み取り権限のみ）
* 受信トレイのメール一覧表示機能
* メール詳細表示機能
* Gemini API連携によるメール重要度判定機能
* 重要度に基づくメールの視覚的区別（指定色によるアイコン、色分けなど）
* 重要なメールのフィルタリング表示機能
* バックエンドAPIの開発（AWS Lambda, API Gateway）
* ユーザー設定、メールメタデータ、重要度判定結果の保存（AWS DynamoDB）
* APIキー等の機密情報管理（AWS Secrets Manager）
* 定期的なメールチェック処理のスケジューリング（AWS EventBridge）

#### 2.2.2. スコープ外 (Out-of-Scope) - 初期バージョン
* メール送信機能
* メールへの返信、転送機能
* 複数Gmailアカウント対応
* オフラインでのメール閲覧機能（基本的なキャッシュを除く）
* 添付ファイルのダウンロード・プレビュー機能（S3利用はオプションとして検討するが初期スコープ外）
* 高度なキーワード検索以外の検索機能（例：差出人、期間指定など）
* ユーザーによる重要度判定基準のカスタマイズ機能（例：特定の差出人を常に重要とするルール設定）
* プッシュ通知機能（新着重要メールの通知など。将来的な拡張機能として検討）
* 広告表示
* タブレットや折り畳みデバイスへの最適化UI（初期はスマートフォン標準UI）

### 2.3. 対象ユーザー
* 日常的にGmailを利用し、多くのメールを受信する個人ユーザー。
* 重要なメールを見逃したくない、またはメール整理の効率を上げたいと考えているユーザー。
* 新しい技術やAIを活用したツールに関心のあるユーザー。
* Androidスマートフォンを主に使用しているユーザー。

## 3. 機能要件

### 3.1. ユーザー認証機能 (FR-AUTH)
* **FR-AUTH-001:** ユーザーは、Google Sign-Inを使用して本アプリに安全にサインインできる。
    * UI: アプリ初回起動時またはサインアウト後に表示されるログイン画面には、「Googleでサインイン」ボタンを配置する。ボタンデザインは基本デザインテーマ（黒ベース、白文字）に準拠する。
* **FR-AUTH-002:** サインイン時、本アプリはGmail APIへのアクセスに必要な権限（`gmail.readonly` スコープを想定）の同意をユーザーに求める。
    * UI: Googleアカウント選択後、標準のGoogle同意画面が表示される。同意内容は明確に「メールの閲覧のみ」であることを示す。
* **FR-AUTH-003:** ユーザーの認証情報は、AWS Cognitoを利用して安全に管理される。IDトークン、アクセストークン、リフレッシュトークンが適切に扱われる。
* **FR-AUTH-004:** ユーザーは、本アプリの設定画面からサインアウトできる。
    * UI: 設定画面に「サインアウト」ボタンを配置する。タップ時に確認ダイアログを表示する（例：「サインアウトしますか？」）。
* **FR-AUTH-005:** サインアウト後、ローカルに保存されたセッション情報（トークン等）や一時的なユーザーデータ（キャッシュされたメール情報など）は適切にクリアされる。

### 3.2. Gmail連携機能 (FR-GMAIL)
* **FR-GMAIL-001:** 本アプリは、ユーザーの承認に基づき、Gmail APIを介して受信トレイのメールを取得できる。
* **FR-GMAIL-002:** バックエンドシステムは、AWS EventBridgeにより定期的に（例：15分ごと。この間隔は設定可能である必要はないが、将来的な変更可能性は考慮）ユーザーの新しいメールをGmail APIから取得する。
    * 取得対象：主に受信トレイ（`INBOX`）。迷惑メール（`SPAM`）やゴミ箱（`TRASH`）は対象外とする。
* **FR-GMAIL-003:** 取得するメール情報は、差出人（名前とメールアドレス）、受信日時（UTC）、件名、本文プレビュー（例：最初の200文字、HTMLタグは除去）、メール本文（プレーンテキスト形式を優先、HTML形式も取得しバックエンドで処理）、ユニークなメールIDを含む。
* **FR-GMAIL-004:** APIキー（Gmail API, Gemini API）はAWS Secrets Managerに安全に格納され、バックエンドのLambda関数からのみアクセスされる。

### 3.3. メール表示機能 (FR-DISP)
* **FR-DISP-001:** ユーザーは、受信トレイのメール一覧を時系列（新着順）で表示できる。
    * UI: メイン画面にメール一覧を表示。上部に最新のメールが来るようにソート。基本デザインは黒ベース、白文字とする。
* **FR-DISP-002:** メール一覧には、各メールの差出人名、件名、受信日時（相対表示、例：「5分前」「昨日 10:20」「5月7日」）、重要度を示すインジケータが表示される。
    * **差出人名・件名の表示:** 1行で表示し、長すぎる場合は末尾を「...」で省略する。最大表示文字数（または幅）は設計で定義。文字色は白を基本とする。
    * **受信日時の表示形式:**
        * 当日中: 「HH:mm」（例: 「10:30」）
        * 昨日: 「昨日 HH:mm」（例: 「昨日 15:20」）
        * それ以前（当年中）: 「M月d日」（例: 「5月7日」）
        * それ以前（過去年）: 「yyyy年M月d日」（例: 「2023年12月1日」）
    * **重要度インジケータ:** （基本デザインは黒ベース・白文字のシックなモノトーンを基調とする）
        * 優先度に応じて、メール一覧の各行に視覚的なアクセントを加える。
        * 例1: メールの左端に配置する小さな円形アイコンまたは縦線。色は優先度に応じて赤・青・黄を使用する。
            * 高優先度: 赤色のインジケータ
            * 中優先度: 青色のインジケータ
            * 低優先度: 黄色のインジケータ
            * (注: 上記の色と優先度のマッピングは提案であり、設計段階で最終決定する。)
        * Gemini APIの判定結果（例：「重要」「普通」「低関心」など）をこれらの色にどうマッピングするか定義する。
* **FR-DISP-003:** ユーザーは、メール一覧から特定のメールを選択し、その詳細（差出人名、差出人メールアドレス、受信者名/アドレス（To, Cc）、受信日時（詳細な日時形式、例：「2025年5月7日(水) 10:30:15」）、件名、本文全文（プレーンテキスト表示を基本とし、HTMLメールの場合は簡易レンダリングを試みるか、テキスト抽出を強化する））を閲覧できる。
    * UI: メール詳細画面では、ヘッダー情報と本文をスクロール可能な領域に表示する。基本デザインは黒ベース、白文字とする。
* **FR-DISP-004:** 未読メールは視覚的に区別して表示される。
    * 例: 差出人名と件名を白文字の太字で表示。メール行の背景色を基本の黒よりわずかに明るいグレーにするなど、モノトーンの範囲で区別する。
* **FR-DISP-005:** メール一覧は、スクロールにより追加のメールを読み込める（無限スクロール方式を採用）。一度に読み込む件数（例：20件）は設計で定義。
* **FR-DISP-006:** メール一覧の読み込み中や、メール詳細表示の際に、適切なローディングインジケータ（基本デザインに合わせたシンプルなもの）を表示する。
* **FR-DISP-007:** メール一覧が空の場合（該当するメールがない場合）は、その旨をユーザーに分かりやすく表示する（例：「表示するメールがありません」）。

### 3.4. 重要度判定機能 (FR-IMPORT)
* **FR-IMPORT-001:** バックエンドシステムは、取得した各メールの本文（プレーンテキスト形式を優先）、件名、差出人情報をGemini APIに送信し、メールの重要度判定をリクエストする。
    * **プロンプトエンジニアリング:** Gemini APIへのプロンプトは、メールの文脈（例：仕事関連か、個人的なものか、緊急性が高いか、情報提供か、宣伝かなど）を考慮し、一貫性のある判定結果が得られるように設計・調整する。プロンプトの例は設計ドキュメントに記載。
    * Gemini APIのモデル選定：コストと性能のバランスを考慮してモデル（例：Gemini 1.5 Flash, Gemini 1.5 Proなど）を選定する。
* **FR-IMPORT-002:** Gemini APIから返却された重要度判定結果（例：{"importance_level": "high", "reason": "会議の案内です"} や {"priority_score": 0.9} など、具体的な出力形式は設計で定義）は、メールのメタデータと共にDynamoDBに保存される。
    * 保存する判定結果：重要度カテゴリ（例：高、中、低。FR-DISP-002のインジケータ色と対応）、（可能であれば）判定理由の短い要約。
* **FR-IMPORT-003:** 重要度の判定ロジックやGemini APIへのプロンプトは、効果的な判定結果が得られるように設計・調整される。初期リリース後も継続的な改善を見込む。
* **FR-IMPORT-004:** フロントエンドは、バックエンドから取得した重要度判定結果に基づき、メール一覧や詳細画面で重要度をFR-DISP-002で定義されたインジケータで視覚的に表示する。

### 3.5. メールフィルタリング・ソート機能 (FR-FILTER)
* **FR-FILTER-001:** ユーザーは、重要と判定されたメール（例：重要度「高」のメール、赤色のインジケータが付いたメール）のみをフィルタリングして表示できる。
    * UI: メール一覧画面の上部やメニューにフィルタリングオプションを配置する（例：トグルボタン「重要のみ表示」、ドロップダウンメニューなど）。UIは基本デザインテーマに準拠する。
    * フィルタリング状態はアプリ終了後も保持される（要検討）。
* **FR-FILTER-002:** （オプション、初期スコープ外の可能性あり）ユーザーは、未読メールのみをフィルタリングして表示できる。
* **FR-FILTER-003:** メール一覧のデフォルトソート順は新着順とする。他のソートオプション（例：差出人順、重要度順）は初期スコープ外。

### 3.6. 設定機能 (FR-SET) - (初期は最小限)
* **FR-SET-001:** ユーザーは、アプリのバージョン情報を確認できる画面にアクセスできる。
    * UI: 設定画面内に「バージョン情報」項目を設け、タップするとバージョン番号（例：1.0.0）を表示。
* **FR-SET-002:** ユーザーは、設定画面からサインアウトを実行できる（FR-AUTH-004参照）。
* **FR-SET-003:** （オプション）プライバシーポリシーや利用規約へのリンクを表示する。

## 4. 非機能要件

### 4.1. パフォーマンス (NFR-PERF)
* **NFR-PERF-001:** アプリケーションの起動時間は、コールドスタートで平均5秒以内、ウォームスタートで平均2秒以内を目指す（一般的なミドルレンジのAndroidデバイスで測定）。
* **NFR-PERF-002:** メール一覧の初期表示（最初の20件）は、ネットワーク環境が良好な場合（Wi-Fi接続またはLTE接続で下り5Mbps以上）、平均3秒以内に完了する。
* **NFR-PERF-003:** メール詳細画面の表示は、平均2秒以内に完了する。
* **NFR-PERF-004:** バックエンドでの新規メール取得と重要度判定処理は、1メールあたり平均10秒以内に完了する（Gemini APIの応答時間に大きく依存するため、APIのSLAも考慮）。
* **NFR-PERF-005:** UI操作（スクロール、タップなど）に対する応答は、0.1秒以内とし、カクつきや遅延を感じさせない。

### 4.2. セキュリティ (NFR-SEC)
* **NFR-SEC-001:** ユーザーのGmail認証情報（アクセストークン、リフレッシュトークン）は、Android標準のセキュリティ機構（例：AccountManager, Android Keystore System）を利用して安全に保存・管理される。
* **NFR-SEC-002:** フロントエンドとバックエンド間の通信は、全てHTTPS (TLS 1.2以上)で暗号化される。
* **NFR-SEC-003:** AWSの各サービス（Lambda, API Gateway, DynamoDB, Cognito, Secrets Manager, IAM）は、最小権限の原則に基づき、適切にアクセス制御される。IAMロールの権限は定期的に見直す。
* **NFR-SEC-004:** Gmail APIキーおよびGemini APIキーは、AWS Secrets Managerに安全に保管され、アプリケーションコード内にハードコードされない。これらのキーへのアクセスも最小限のLambda関数に限定する。
* **NFR-SEC-005:** 依存ライブラリは定期的に脆弱性スキャン（例：GitHub Dependabot alerts, Snykなど）を行い、重大な脆弱性が発見された場合は速やかにアップデートする。
* **NFR-SEC-006:** 入力値の検証：API GatewayやLambda関数で、外部からの入力値（リクエストパラメータ、ボディなど）に対するバリデーションを適切に行う。

### 4.3. ユーザビリティ (NFR-USAB)
* **NFR-USAB-001:** アプリケーションのUIは直感的で、主要な機能（メール一覧表示、メール詳細表示、重要メールフィルタリング、サインアウト）はアプリ起動後、またはメイン画面から3タップ以内でアクセス可能である。
* **NFR-USAB-002:** 重要な情報（未読、重要度など）は視覚的に分かりやすく表示され、ユーザーが誤操作しにくいデザインとする。タップ可能な領域は十分に確保する（最低48dp x 48dp）。
* **NFR-USAB-003:** エラーメッセージは、ユーザーに分かりやすい言葉で表示され、可能な場合は具体的な対処法（例：「ネットワーク接続を確認してください」）を示す。汎用的なエラーコードのみの表示は避ける。
* **NFR-USAB-004:** アプリケーションの基本デザインは、黒を基調としたシックなモノトーン（ダークテーマ）とし、文字色は白を基本とする。Androidの標準的なUIガイドライン（Material Design 3）に準拠し、一貫性のある操作感を提供する。ライトテーマへの対応は、必要に応じて将来的な拡張として検討する。
* **NFR-USAB-005:** アクセシビリティ：基本的なアクセシビリティ機能（TalkBackによる読み上げ対応、十分なコントラスト比など）を考慮する。

### 4.4. 信頼性 (NFR-REL)
* **NFR-REL-001:** アプリケーションのクラッシュ率は、Firebase Crashlytics等で計測し、ユーザーセッションの0.1%以下を目指す。
* **NFR-REL-002:** Gmail APIやGemini APIの一時的なエラーが発生した場合、バックエンドで指数バックオフを用いたリトライ処理を適切に行い、ユーザーへの影響を最小限に抑える。リトライ上限を超えた場合はエラーとして記録する。
* **NFR-REL-003:** バックエンドの定期メール取得処理は、99.9%の成功率で実行される。処理の失敗はCloudWatch Logs等で監視し、アラートを設定する。
* **NFR-REL-004:** データ整合性：DynamoDBに保存されるメール情報と重要度判定結果の整合性を保つ。

### 4.5. 拡張性 (スケーラビリティ) (NFR-SCAL)
* **NFR-SCAL-001:** バックエンドシステムはAWSのサーバーレスアーキテクチャ（Lambda, API Gateway, DynamoDB）を採用し、ユーザー数や処理メール数の増加に応じて自動的にスケールするように設計する。各サービスのクォータ（制限）を意識した設計を行う。
* **NFR-SCAL-002:** 将来的な機能追加（例：プッシュ通知、複数アカウント対応、検索機能強化など）を考慮し、モジュール化された疎結合な設計とする。

### 4.6. 保守性 (NFR-MAIN)
* **NFR-MAIN-001:** ソースコードはKotlinの公式コーディング規約およびチーム内で合意した規約に準拠し、適切なコメント（KDoc形式を推奨）が付与される。
* **NFR-MAIN-002:** フロントエンドはMVVMアーキテクチャ、バックエンドはレイヤードアーキテクチャ（例：Controller-Service-Repository）またはクリーンアーキテクチャに準ずる構造を採用し、コードの可読性とテスト容易性を高める。
* **NFR-MAIN-003:** 主要なビジネスロジック（例：重要度判定のロジック呼び出し部分、データ変換処理など）にはユニットテストが記述され、カバレッジ60%以上を目指す。
* **NFR-MAIN-004:** CI/CDパイプラインを導入し（例：GitHub Actions）、ビルド、静的解析、テスト、デプロイ（バックエンド）の自動化を目指す。

## 5. システム構成概要

### 5.1. フロントエンド (Android)
* **言語:** Kotlin
* **UIフレームワーク:** Jetpack Compose
* **アーキテクチャ:** MVVM (Model-View-ViewModel)
* **非同期処理:** Kotlin Coroutines
* **DI (依存性注入):** Hilt
* **API通信:** Ktor (または Retrofit) - 詳細設計で最終決定

### 5.2. バックエンド (AWS)
* **主要言語:** Kotlin (AWS LambdaのJavaランタイム上で実行。ビルドツールはGradleを推奨)
* **コンピューティング:** AWS Lambda
* **APIエンドポイント:** Amazon API Gateway (REST API)
* **データベース:** Amazon DynamoDB
    * **テーブル例1: UserProfile**
        * `userId` (Partition Key, String): CognitoのユーザーID
        * `email` (String): Gmailアドレス
        * `lastSyncTime` (String, ISO 8601形式): 最終メール同期日時
        * `createdAt` (String, ISO 8601形式)
        * `updatedAt` (String, ISO 8601形式)
    * **テーブル例2: MailMetadata**
        * `userId` (Partition Key, String)
        * `mailId` (Sort Key, String): GmailのユニークメールID
        * `subject` (String): 件名
        * `senderName` (String): 差出人名
        * `senderEmail` (String): 差出人メールアドレス
        * `receivedAt` (String, ISO 8601形式): 受信日時
        * `snippet` (String): 本文プレビュー
        * `importanceScore` (Number): Gemini判定スコア（もしあれば）
        * `importanceCategory` (String): Gemini判定カテゴリ (例: "high", "medium", "low")
        * `isRead` (Boolean): 未読/既読フラグ
        * `processedAt` (String, ISO 8601形式): 重要度判定処理日時
    * （上記はあくまで例。実際のキー設計や属性はデータアクセスパターンを考慮して詳細設計で決定）
* **認証:** Amazon Cognito (Google Sign-Inとフェデレーション)
* **機密情報管理:** AWS Secrets Manager (Gmail APIキー, Gemini APIキー)
* **スケジューリング:** Amazon EventBridge (定期的なメール取得・処理Lambdaのトリガー)
* **アクセス管理:** AWS IAM (最小権限の原則)
* **ストレージ (オプション):** Amazon S3 (メール添付ファイル、静的アセット等。初期スコープ外)
* **IaC (Infrastructure as Code) (推奨):** AWS CDK (TypeScriptまたはKotlin) または AWS SAM/CloudFormation

### 5.3. 主要API連携
* **Gmail API (Google Client Library for Java/Kotlin):** メールの読み取り (`users.messages.list`, `users.messages.get`)
* **Gemini API (Google AI SDK for Android/Java/Kotlin):** メールの重要度判定 (`GenerativeModel.generateContent`)

## 6. 制約条件と前提条件

### 6.1. 制約条件
* 開発言語はフロントエンド・バックエンド共にKotlinを主として使用する。
* バックエンドのインフラはAWSのマネージドサービスを最大限活用する。
* 開発チームにはプログラミング経験の浅いメンバーが含まれるため、学習コストや開発効率を考慮した技術選定を行う。AIエージェントによる学習支援・コード生成を積極的に活用する。
* AIエージェント（GitHub Copilot, ChatGPT, Gemini等）を開発支援ツールとして積極的に活用する。
* 開発期間と予算は別途定義される。本要件定義は、特定の期間や予算を前提とはしていない。
* 本アプリは個人開発または小規模チームでの開発を想定し、初期リリースではスコープ内の機能に限定する。

### 6.2. 前提条件
* 開発メンバーは、基本的なKotlinの文法、Android開発の初歩（Jetpack Composeの基本含む）、Git/GitHubの操作を習得済み、または学習意欲があること。
* AWSアカウントが準備され、必要なサービスへのアクセス権限（IAMユーザー、ロール）が付与されていること。
* Gmail APIおよびGemini APIの利用規約を遵守し、必要なAPIキーが取得可能であること（無料枠または適切な課金プランを想定）。各APIの利用制限（クォータ）も考慮する。
* 開発に必要なPC、Android Studio (最新安定版推奨)、AWS CLI等の開発環境が準備されていること。

## 7. 成果物 (本要件定義書に基づく開発の目標)
* 本要件定義書に記載された機能要件・非機能要件を満たすAndroidアプリケーション。
* AWS上に構築されたバックエンドシステム。
* ソースコード一式（GitHubリポジトリで管理。フロントエンドとバックエンドでリポジトリを分けることも検討）。
* READMEドキュメント（プロジェクト概要、アーキテクチャ図（簡易的なものでも可）、セットアップ方法、API仕様概要、デプロイ手順など）。
* （可能であれば）IaCによるインフラ構成コード。
* （可能であれば）主要なAPIエンドポイントのPostmanコレクションまたはOpenAPI仕様書。

---
**承認欄**

| 役割             | 氏名 | 署名 | 日付 |
| ---------------- | ---- | ---- | ---- |
| プロジェクトオーナー |      |      |      |
| 開発リード         |      |      |      |

